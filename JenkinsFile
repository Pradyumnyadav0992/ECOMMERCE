pipeline{
    agent {
        node {
        label 'Slave_bastion'
        customWorkspace '/home/ubuntu/jenkins_workspace/' 
        }
    }
    environment {
        // VERSION = ''
        DOCKER_USENAME = credentials('DOCKER_CREDENTIALS')
    }

    // parameters {
    //     choice(name: "Version" , choices: ["A","B"], description: "Anything" )
    //     booleanParam(name: 'executeTest', defaultValue: true, description: "hi")
    // }

    stages{

        stage("Checkout") {
            steps {
                git branch: 'main', url: 'https://github.com/Pradyumnyadav0992/ECOMMERCE.git'
                script {
                    def version = sh(script: "git describe --tags --abbrev=0", returnStdout: true).trim()
                    env.VERSION = version
                    echo "Using version: ${env.VERSION}"
                }
            }
        }



        stage("File change List"){
        steps {
            script {
                def changedFiles = sh(script: "git diff --name-only HEAD~1 HEAD", returnStdout: true).trim() 
                env.FILECHANGELIST = changedFiles
                echo "Changed files:\n${env.FILECHANGELIST}"
            }
        }

        }

        stage("JTest"){
            steps {
                echo "Changed files:"
            }
        
        }

        stage("Build"){
                    steps {
                        script{
                            def services =[ 'accounting', 'cart', 'ad', 'checkout', 'currency', 'email', 'frontend-proxy', 'fraud-detection', 'flagd-ui', 'flagd', 'grafana', 'frontend', 'image-provider', 'otel-collector', 'load-generator', 'kafka', 'payment', 'prometheus', 'product-catalog', 'quote', 'recommendation', 'react-native-app', 'shipping']
                            for (i in services){
                                if ( i in env.FILECHANGELIST){
                                        sh '''
                                        set -a
                                        source .env
                                        set +a

                                        echo "Image: $IMAGE_NAME"
                                        echo "Version: $IMAGE_VERSION"
                                        echo "Demo Version: $DEMO_VERSION"

                                        docker build -t ${IMAGE_NAME}:${DEMO_VERSION}-${i} .
                                        '''
                                 }
                             }
                            }


                echo "Changed files:"
            }
        }

        stage("Image Scan"){
                        steps {
                echo "Changed files:"
            }
        }

        stage("Push"){

             steps {
                withCredentials([usernamePassword(credentialsId: 'DOCKER_CREDENTIALS', usernameVariable: 'USER', passwordVariable: 'PASSWD')]) {
                    echo "Pushing Docker image with user $USER"
                    // Example: sh "docker login -u $USER -p $PASSWD"
                }
            }
        }

        stage("Update Manifest"){
             steps {
                echo "Changed files:"
            }
        }
    }
}
